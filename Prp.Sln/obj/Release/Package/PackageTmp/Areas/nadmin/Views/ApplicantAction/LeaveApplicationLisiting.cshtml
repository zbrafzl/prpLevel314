@{ ViewBag.Title = "Leave - Listing";
    Layout = "~/Areas/nadmin/Views/Shared/_Layout.cshtml"; }

@model Prp.Sln.EmptyModelAdmin
@section RenderCss{
    <style>
        .spnLA0 {
            display: none;
        }
    </style>
}
@section RenderScript{
    <script>
        var doc, pageNum = 1, fetchTypeId = 0; typeId = 0, processId = 0, assignToTypeId = 0, hospitalId = 0;

        $(document).ready(function () {

            WebUrlToLowerCase();
            applicantId = ConvertToInt(GetQuerystringValues("applicantid"));
            $("#hfdApplicantId").val(applicantId);

            SearchAndBind();

            $(document).on('click', '#btnSearch', function () {
                pageNum = 1;
                fetchTypeId = 1;
                SearchAndBind();
            });

            $(document).keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13') {
                    $("#tbBody").html("");
                    pageNum = 1;
                    fetchTypeId = 1;
                    SearchAndBind();
                }
            });

            $(document).on('click', '.spnLeaveAppInfo', function () {
                var appId = ConvertToInt($(this).attr("appId"));
                LeaveGetAllByApplicantPopup(appId);
            });



        });

        function PreInitBind(resp) {
            var objUser = resp.Table1[0];
            if (objUser.typeId == 81) // Hospital User
                $("#divHospital").hide();
            else $("#divHospital").show();

            var list = resp.Table2;
            DDLBindList("#ddlHospital", list, "Select One", 0);
            var list = resp.Table3;
            DDLBindList("#ddlStatus", list, "Select One", 0);
            var list = resp.Table4;
            DDLBindList("#ddlType", list, "Select One", 0);
        }

        function SearchAndBind() {

            var obj = SetParameters();
            var resp = CallActionPost("/Common/CallSpGenericToDataSet", obj);

            if (resp != null) {

                if (fetchTypeId == 0) {
                    PreInitBind(resp);
                }
                BindListing(resp);
            }

        }

        function SetParameters() {
            var obj = {};
            obj.spName = "spLeaveApplicantCount";

            var listParam = [];

            var objParam = {};
            objParam.key = "top";
            objParam.value = ConvertToInt($("#ddlTop").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "pageNo";
            objParam.value = pageNum;
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "reffId";
            objParam.value = ConvertToInt($("#hfdLoggedInReffId").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "adminId";
            objParam.value = ConvertToInt($("#hfdLoggedInUserId").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "noOfLeave";
            objParam.value = ConvertToInt($("#ddlHasLeave").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "search";
            objParam.value = ConvertToString($("#txtSearch").val());
            objParam.dataType = "string";
            listParam.push(objParam);

            obj.listParam = listParam;
            return obj;
        }

        function BindListing(resp) {
            $("#tbBody").html("");
            var html = "";

            try {

                var list = resp.Table11;
                if (list != null && list.length > 0) {
                    totalCount = list[0].totalCount;
                    var singleHtml = $("#tbRowHtml").html();
                    var objItem = {};

                    for (var i = 0; i < list.length; i++) {

                        objItem = list[i];

                        html = html + singleHtml.replace(/{#rowNo#}/g, objItem.rowNo).replace(/{#applicantId#}/g, objItem.applicantId)
                            .replace(/{#instituteName#}/g, objItem.instituteName).replace(/{#hospitalName#}/g, objItem.hospitalName)
                            .replace(/{#specialityName#}/g, objItem.specialityName).replace(/{#hospital#}/g, objItem.hospital)
                            .replace(/{#nameFull#}/g, objItem.nameFull).replace(/{#pmdcNo#}/g, objItem.pmdcNo)
                            .replace(/{#relation#}/g, objItem.relation).replace(/{#cnic#}/g, objItem.cnic)
                            .replace(/{#noOfLeave#}/g, objItem.noOfLeave);
                    }
                    if (totalCount > 0)
                        CreatePaginationHtml(perPageRecords, totalCount, pageNum);
                }

            } catch (e) {
                html = "";
            }
            $("#tbBody").html(html);


            $(".tdHospital").show();
            var hospitalId = ConvertToInt($("#ddlHospital").val());
            if (hospitalId > 0)
                $(".tdHospital").hide();

        }

        function LeaveGetAllByApplicantPopup(appId) {
            try {
                var obj = {};
                obj.spName = "spLeaveGetAllByApplicant";

                var listParam = [];

                var objParam = {};
                objParam.key = "applicantId";
                objParam.value = appId;
                objParam.dataType = "int";
                listParam.push(objParam);
                obj.listParam = listParam;

                var resp = CallActionPost("/Common/CallSpGenericToDataSet", obj);
                if (resp != null) {
                    BindHtmlLeaveByApplicantPopup(resp.Table11);
                }
            } catch (e) {
            }
            $('#mdLeaveByApp').modal('show');
        }

        function BindHtmlLeaveByApplicantPopup(list) {

            var html = "";
            try {
                if (list != null && list.length > 0) {
                    var objItem = {};
                    var htmlSingle = $('#tbRowLeaveApp').html();
                    for (var i = 0; i < list.length; i++) {
                        objItem = list[i];
                        html = html + htmlSingle.replace(/{#rowNo#}/g, objItem.rowNo)
                            .replace(/{#hospital#}/g, objItem.hospital).replace(/{#typeName#}/g, objItem.typeName)
                            .replace(/{#duration#}/g, objItem.duration).replace(/{#status#}/g, objItem.status);
                    }
                }
                else {
                    html = $('#tbRowLeaveAppNoRecord').html();
                }
            } catch (e) {
                html = "";
            }
            $('#tbBodyLeaveApp').html(html);
        }

    </script>

}
<div class="col-md-12 col-sm-12  ">
    <div class="x_panel">
        <div class="x_title">
            <h2>Leave List </h2>
            <div class="clearfix"></div>
        </div>
        <form class="form-horizontal form-label-left input_mask">
            <div class="form-group col-lg-12">
                <div id="divHospital" class="col-md-3 col-sm-3 col-xs-3" style="display:none;">
                    <label for="heard">Hospital :</label>
                    <select id="ddlHospital" name="ddlHospital" class="form-control">
                    </select>
                </div>
                <div class="col-md-3 col-sm-3 col-xs-3">
                    <label for="heard">Search :</label>
                    <input type="text" id="txtSearch" name="txtSearch" placeholder="Search By Speciality, Hospital" class="form-control" />
                </div>
                <div class="col-md-2 col-sm-2 col-xs-2">
                    <label for="heard">Has Leave :</label>
                    <select id="ddlHasLeave" name="ddlTop" class="form-control">
                        <option value="99999" selected="selected"> All </option>
                        <option value="1"> Has Leave </option>
                        <option value="0"> No Leave </option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-2 col-xs-2">
                    <label for="heard">Top :</label>
                    <select id="ddlTop" name="ddlTop" class="form-control">
                        <option value="20" selected="selected"> 20 </option>
                        <option value="50"> 50 </option>
                        <option value="100"> 100 </option>
                        <option value="1000"> 1000 </option>
                        <option value="5000"> 5000 </option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-2 col-xs-2">
                    <label for="heard" style="width:100%;">&nbsp;</label>
                    <input type="button" id="btnSearch" name="btnSearch" value="Search" class="btn btn-success" />
                </div>

            </div>
            <div class="clearfix"></div>
            <div class="ln_solid"></div>
        </form>
        <div class="x_content">
            <div class="table-responsive">
                <table id="tblPanel" class="table table-striped jambo_table bulk_action">
                    <thead>
                        <tr class="headings">
                            <th class="column-title">Sr. </th>
                            <th class="column-title tdHospital">Hospital</th>
                            @*<th class="column-title">Institute</th>
                                <th class="column-title">Hospital</th>
                                <th class="column-title">Speciality</th>*@
                            <th class="column-title">Name</th>
                            <th class="column-title">Pmdc</th>
                            <th class="column-title">Cnic</th>
                            <th class="column-title">No Of Leave</th>
                            <th class="column-title">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tbBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div style="display:none;">
    <table>
        <tbody id="tbRowHtml">
            <tr class="tbRow">
                <td>{#rowNo#}</td>
                <td class="tdHospital">{#hospital#}</td>
                @*<td>{#instituteName#}</td>
                    <td>{#hospitalName#}</td>
                    <td>{#specialityName#}</td>*@
                <td>{#nameFull#}</td>
                <td>{#pmdcNo#}</td>
                <td>{#cnic#}</td>
                <td>{#noOfLeave#}</td>
                <td>
                    <a title="Apply Leave " class="ank" href="/admin/leave?appid={#applicantId#}"><i class="fa fa-file-text"></i></a>
                    <span title="View Applicant leaves " class="ank spnLA{#noOfLeave#} spnLeaveAppInfo" appId="{#applicantId#}">  &nbsp;| &nbsp; <i class="fa fa-eye"></i> </span>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="mdLeaveByApp" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Leave Report By Applicant </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row main">
                    <div class="col-sm-1"></div>
                    <div class="col-sm-10 form-box mn0" style="height: 470px; padding: 0px;">
                        <div class="main-login main-center">
                            <table class="table table-striped jambo_table bulk_action" style="height:455px; overflow-y:scroll; display:block;">
                                <thead>
                                    <tr class="headings">
                                        <th class="column-title">Sr </th>
                                        <th class="column-title">Hospital</th>
                                        <th class="column-title">Type </th>
                                        <th class="column-title">Duration</th>
                                        <th class="column-title">Status </th>
                                    </tr>
                                </thead>
                                <tbody id="tbBodyLeaveApp">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="display:none;">
    <table>
        <tbody id="tbRowLeaveApp">
            <tr>
                <td>{#rowNo#}</td>
                <td>{#hospital#}</td>
                <td>{#typeName#}</td>
                <td>{#duration#}</td>
                <td>{#status#}</td>
            </tr>
        </tbody>
        <tbody id="tbRowLeaveAppNoRecord">
            <tr>
                <td colspan="5" style="text-align:center;">No record found</td>
            </tr>
        </tbody>
    </table>
</div>