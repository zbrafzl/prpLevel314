@{
    ViewBag.Title = "Ticker Setup";
    Layout = "~/Areas/nadmin/Views/Shared/_Layout.cshtml";
}
@model Prp.Sln.EmptyModelAdmin
@section RenderCss{

}
@section RenderScript{

    @*<script src="~/ckfinder/ckfinder.js"></script>
        <script src="~/ckeditor/ckeditor.js"></script>*@

    <script src="https://cdn.ckeditor.com/ckeditor5/30.0.0/classic/ckeditor.js"></script>
    <script type="text/javascript">
        var txtDetaiLong;
        ClassicEditor
            .create(document.querySelector('#idPnlDetaiLong'))
            .then(editor => {
                txtDetaiLong = editor;
            })
            .catch(error => {
                console.error(error);
            });

    </script>

    <script>
        var tickerId = 0;
        $(document).ready(function () {

            WebUrlToLowerCase();
            tickerId = ConvertToInt(GetQuerystringValues("id"));
            GetAndBindData();

            $(document).on('click', '#btnSave', function () {
                SaveFormData();
            });

            $(document).keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13') {
                    SaveFormData();
                }
            });

        });

        function SetParameters() {

            var obj = {};
            obj.spName = "spTickerGetById";

            var listParam = [];

            var objParam = {};
            objParam.key = "tickerId";
            objParam.value = tickerId
            objParam.dataType = "int";
            listParam.push(objParam);


            obj.listParam = listParam;

            return obj;
        }

        function GetAndBindData() {

            var obj = SetParameters();
            var resp = CallActionPost("/CommonFunctionsAdmin/CallSpGenericToDataSet", obj);

            if (resp != null) {

                PreInitBindForm(resp);

                var obj = resp.Table8[0];

                if (obj.tickerId > 0) {
                    BindFrom(obj);
                }

                DDLTypeChangeEvent();
            }
        }

        var listDetailId = [];
        function PreInitBindForm(resp) {

            var listProj = resp.Table;
            DDLBindList("#ddlProj", listProj, "Select One", -9);
            $("#ddlProj").val(1);

            var listReff = resp.Table2;
            DDLBindList("#ddlReff", listReff, "Select One", -9);
            $("#ddlReff").val(1);

            var listType = resp.Table4;
            DDLBindList("#ddlType", listType, "Select One", -9);
            $("#ddlType").val(1);

            listDetailId = resp.Table6;// induction, hardship

            DDlEventChangeReff();
        }

        function DDlEventChangeReff() {
            var reffId = ConvertToString($("#ddlReff").val());

            var list = [];
            try {
                list = $.grep(listDetailId, function (n, i) {
                    return n.reffId == reffId;
                });
            } catch (e) {
                list = [];
            }

            if (list.length == 0) {
                var obj = {};
                obj.key = "Select One";
                obj.value = 0;
                list.push(obj);
            }

            DDLBindList("#ddlDetailId", list, "Select One", -9);
        }

        function BindFrom(obj) {
            $("#ddlProj").val(obj.projId);
            $("#ddlType").val(obj.typeId);
            $("#ddlReff").val(obj.reffId);
            DDlEventChangeReff();
            $("#ddlDetailId").val(obj.detailId);
            $("#txtName").val(obj.name);
            $("#txtSortOrder").val(obj.sortOrder);
            if (obj.typeId == 1)
                $("#txtDetailShort").val(obj.detail);
            else
                //$("#txtDetailLong").val(obj.detail);
                txtDetaiLong.setData(obj.detail);


            $("#chkStatus").prop("checked", obj.isActive);
        }

        function DDLTypeChangeEvent() {
            var typeId = ConvertToInt($("#ddlType").val());

            $("#divShort").hide();
            $("#divLong").hide();

            if (typeId == 1)
                $("#divShort").show();
            else
                $("#divLong").show();
        }

        function SaveFormData() {

            var obj = ValidateForm();
            if (obj.isOk == true) {
                var resp = CallActionPost("/CommonFunctionsAdmin/CallSpGenericToMessage", obj);
                if (resp.status == true) {
                    window.location.href = "/admin/ticker-manage";
                }
            }
        }



        function ValidateForm() {

            var obj = {};
            var isOk = true, ctrl = "";

            try {
                obj.name = ConvertToString($("#txtName").val());
                var typeId = ConvertToInt($("#ddlType").val());
                if (typeId == 1)
                    obj.detail = ConvertToString($("#txtDetailShort").val());
                else obj.detail = txtDetaiLong.getData(); //ConvertToString($("#txtDetailLong").val());
                obj.sortOrder = ConvertToInt($("#txtSortOrder").val());

                obj.isActive = $("#chkStatus").is(":checked");

                if (obj.name == "") {
                    isOk = false;
                }
                if (obj.detail == "") {
                    isOk = false;
                }

            } catch (e) {
                isOk = false;
            }
            obj.isOk = isOk;

            obj.spName = "spTickerAddUpdate";
            var listParam = [];

            var objParam = {};
            objParam.key = "projId";
            objParam.value = ConvertToInt($("#ddlProj").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "typeId";
            objParam.value = ConvertToInt($("#ddlType").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "reffId";
            objParam.value = ConvertToInt($("#ddlReff").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "detailId";
            objParam.value = ConvertToInt($("#ddlDetailId").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "tickerId";
            objParam.value = tickerId;
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "name";
            objParam.value = obj.name;
            objParam.dataType = "string";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "sortOrder";
            objParam.value = obj.sortOrder;
            objParam.dataType = "int";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "isActive";
            objParam.value = obj.isActive;
            objParam.dataType = "bool";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "detail";
            objParam.value = obj.detail;
            objParam.dataType = "string";
            listParam.push(objParam);

            var objParam = {};
            objParam.key = "adminId";
            objParam.value = ConvertToInt($("#hfdLoggedInUserId").val());
            objParam.dataType = "int";
            listParam.push(objParam);

            obj.listParam = listParam;

            return obj;
        }

    </script>
}
<div class="row">
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>Ticker Setup </h2>
                <div class="panel_toolbox">
                    <a href="/admin/ticker-manage" class="btn btn-info"> Manage</a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <br />
                <form id="demo-form2" data-parsley-validate class="form-horizontal form-label-left">
                    <div class="form-group col-lg-12">
                        <div class="col-md-3 col-sm-3 col-xs-3">
                            <label for="heard">Project :</label>
                            <select id="ddlProj" name="ddlProj" class="form-control">
                            </select>
                        </div>
                        <div class="col-md-3 col-sm-3 col-xs-3">
                            <label for="heard">Type :</label>
                            <select id="ddlType" name="ddlType" class="form-control ddl-event" fn="DDLTypeChangeEvent">
                            </select>
                        </div>
                        <div class="col-md-3 col-sm-3 col-xs-3">
                            <label for="heard">Reff :</label>
                            <select id="ddlReff" name="ddlReff" class="form-control ddl-event" fn="DDlEventChangeReff">
                            </select>
                        </div>
                        <div class="col-md-3 col-sm-3 col-xs-3">
                            <label for="heard">Detail Id :</label>
                            <select id="ddlDetailId" name="ddlDetailId" class="form-control">
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-lg-12">
                        <div class="col-md-8 col-sm-8 col-xs-8">
                            <label for="heard">Name *:</label>
                            <input type="text" id="txtName" class="form-control required" />
                        </div>
                        <div class="col-md-2 col-sm-2 col-xs-2">
                            <label for="heard">Sort Order *:</label>
                            <input type="text" id="txtSortOrder" class="form-control required" />
                        </div>
                        <div class="col-md-2 col-sm-2 col-xs-2">
                            <label for="heard">Status *:</label>
                            <input type="checkbox" id="chkStatus" class="form-control" />
                        </div>
                    </div>
                    <div id="divShort" class="form-group col-lg-12" style="display:none;">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <label for="heard">Detail :</label>
                            <input type="text" id="txtDetailShort" class="form-control" />
                        </div>
                    </div>
                    <div id="divLong" class="form-group col-lg-12" style="display:none;">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <label for="heard">Detail :</label>
                            <div id="idPnlDetaiLong">
                                <textarea id="txtDetailLong" class="form-control ckeditor"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="ln_solid"></div>
                    <div class="item form-group">
                        <div class="col-md-6 col-sm-6 offset-md-3">
                            <input type="button" id="btnSave" class="btn btn-success" value="Submit" />
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>